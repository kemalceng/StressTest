<!DOCTYPE html>
<html>

<head>
  <script src="https://canvasjs.com/assets/script/canvasjs.min.js"></script>
  <script src="https://code.jquery.com/jquery-2.2.3.min.js"></script>

  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.bundle.min.js"></script>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
  <script src="/socket.io/socket.io.js"></script>

  <meta charset='utf-8'>
  <title>SDMT Testi</title>
  <link rel="stylesheet" href="../resources/css/mystyle.css">
</head>

<script>
  var lastDropboxFileId;

  var socket = io('/');
  socket.on('connect', function () {
    console.log("Websocket Connected, id: ", socket.id);

    document.getElementById("wsId").innerHTML = socket.id.substr(0, 4).toLowerCase();

  });
  socket.on('disconnect', function () { });

  socket.on('start-test', function (fileId) {
    console.log("Starting test! File Id:", fileId);
    lastDropboxFileId = fileId;

    document.getElementById("dropboxFile").value = fileId;

    startRestTimer();
  });

</script>

<script src="httpHelper.js"></script>
<script src="dropboxHelper.js"></script>

<body>
  <div id="container">
    <div>
      <span id="lblCount">Adet: </span><input id="imageCount" type="number" style="width: 50px" onchange="onSdmtImageCountChanged()"/>

      <button id="btnStart" onclick="startRestTimer()" ondblclick="a = 1">Teste başla</button>
      <button id="btnStop" onclick="stopTest(true)" disabled=true>Durdur</button>
      <span id="lblClientId">Kullanıcı ID: </span><output id="wsId"></output>
    </div>
    <div>
      <div id="alert"></div>
    </div>
    <div>
      <audio id="warningAudio" controls hidden>
        <source src="../resources/sounds/warning.mp3" type="audio/mpeg">
        Your browser does not support the audio tag.
      </audio>
    </div>
    <div>
      <div id="ongoingTest" style="flex-direction:column; align-items:center; display: none;">
        <img src="../resources/images/sdmt.png" style="height: 200px"/>
        <div style="width: 800px;height: 365px;display: flex;align-items: center;flex-direction: column;justify-content: center;">
          <div>
              <img id="operationImage" src="../resources/images/plus.png" style="max-height: 365px; display: none; margin-right: 30px"/>
              <img id="askedImage" style="max-height: 365px"/>
          </div>
        </div>
      </div>
      <img id="testImage" src="../resources/images/sdmtTest.png" style="width:800px;height:600px"/>
    </div>
    <div id="selectionBar" style="display:none;">
      <table>
        <tr>
          <td onclick="answer(1)">
            <input type="radio" name="answerSelection" value="1" /><span style="padding-left: 10px;">1</span>
          </td>
          <td onclick="answer(2)">
            <input type="radio" name="answerSelection" value="2" /><span style="padding-left: 10px;">2</span>
          </td>
          <td onclick="answer(3)">
            <input type="radio" name="answerSelection" value="3" /><span style="padding-left: 10px;">3</span>
          </td>
          <td onclick="answer(4)">
            <input type="radio" name="answerSelection" value="4" /><span style="padding-left: 10px;">4</span>
          </td>
          <td onclick="answer(5)">
            <input type="radio" name="answerSelection" value="5" /><span style="padding-left: 10px;">5</span>
          </td>
          <td onclick="answer(6)">
            <input type="radio" name="answerSelection" value="6" /><span style="padding-left: 10px;">6</span>
          </td>
          <td onclick="answer(7)">
            <input type="radio" name="answerSelection" value="7" /><span style="padding-left: 10px;">7</span>
          </td>
          <td onclick="answer(8)">
            <input type="radio" name="answerSelection" value="8" /><span style="padding-left: 10px;">8</span>
          </td>
          <td onclick="answer(9)">
            <input type="radio" name="answerSelection" value="9" /><span style="padding-left: 10px;">9</span>
          </td>
        </tr>
      </table>
    </div>
    <div id="sumAnswerBar" style="display: none">
      <span id="lblSum">Toplam: </span><input id="sumAnswer" type="number" style="width: 50px"/>
    </div>
    <div>
      <button type="button" onclick="listFolders('sdmt')" class="btn btn-info btn-sm" data-toggle="modal" data-target="#modalSelectRecord">Dropbox</button>
      <input id="dropboxFile" type="text" placeholder="Dropbox id"/>
      <button id="btnLoadRecords" onclick="loadFromDropbox('sdmt')">Yükle</button>
    </div>

    <div id="edaChartContainer" style="height: 300px; width: 100%;"></div>
    <div id="ecgChartContainer" style="height: 300px; width: 100%;"></div>

    <div id="adjustTimeMode" style="display: none">
      <span id="adjust_Time_Mode">Zaman Ayarlama Modu :</span><input id="adjustTimeModeOn" type="radio"
        name="adjustTimeMode" /><span id="adjust_Time_Mode_On">Açık</span>
      <input id="adjustTimeModeOff" type="radio" name="adjustTimeMode" checked /><span
        id="adjust_Time_Mode_Off">Kapalı</span>
    </div>

    <!--Perform translation -->
    <script type="text/javascript" src="../resources/js/translate.js"></script>

    <!-- Modal -->
    <div id="modalSelectRecord" class="modal fade" role="dialog">
      <div class="modal-dialog">
        <!-- Modal content-->
        <div class="modal-content">
          <div class="modal-header">
            <h4 class="modal-title" id="lblSelectRecord">Select Record</h4>
            <button type="button" class="close" data-dismiss="modal">&times;</button>
          </div>
          <div id="recordListInModal" class="modal-body"/>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <script type="text/javascript">
      window.addEventListener('load', init, false);
      window.addEventListener('keydown', this.keyPress, false);

      var adjustmentInMs = 0;
      var deltaInMs = 250;

      function keyPress(e) {
        var code = e.key;

        if(isCalculationTestStarted && code === 'Enter') {
          answer(sumAnswerInput.value);
          sumAnswerInput.value = '';
          sumAnswerInput.focus();
        } else if (isStarted && !isCalculationTestStarted) {
          switch (code) {
            case '1': answer(1); break; //1 key
            case '2': answer(2); break; //2 key
            case '3': answer(3); break; //3 key
            case '4': answer(4); break; //4 key
            case '5': answer(5); break; //5 key
            case '6': answer(6); break; //6 key
            case '7': answer(7); break; //7 key
            case '8': answer(8); break; //8 key
            case '9': answer(9); break; //9 key
            default: // Do nothing
          }
        } else {
          switch (code) {
            // + key
            case '+': adjustmentInMs += deltaInMs; console.log("Adjustment: " + adjustmentInMs); break;
            // * key
            case '*': adjustmentInMs -= deltaInMs; console.log("Adjustment: " + adjustmentInMs); break;
          }
        }
      }

      const rootMeanSquare = xs =>
        Math.sqrt(
          xs.reduce(
            (a, x) => (a + x * x),
            0
          ) / xs.length
        );

      function standardDeviation(values) {
        var avg = average(values);

        var squareDiffs = values.map(function (value) {
          var diff = value - avg;
          var sqrDiff = diff * diff;
          return sqrDiff;
        });

        var avgSquareDiff = average(squareDiffs);

        var stdDev = Math.sqrt(avgSquareDiff);
        return stdDev;
      }

      function average(data) {
        var sum = data.reduce(function (sum, value) {
          return sum + value;
        }, 0);

        var avg = sum / data.length;
        return avg;
      }

      var imageSequence = [];
      var allSdmtImages = [];
      var sdmtImageIndex = 0;
      var numberOfImages = 20;
      var restTimer = null;
      var imagesShownTimeList = [];
      var edaInitTime, accInitTime, hrInitTime, temperatureInitTime, ecgInitTime;
      var edaFrequency, accFrequency, edaPeriodInMs, ecgFrequency;
      var hrFrequency, temperatureFrequency;
      var edaInitIndex = 0, hrInitIndex = 0, temperatureInitIndex = 0;
      var increment, accIncrement, hrIncrement;
      var lastImageShownTime = null;
      var testStartDate = null;
      var image = document.getElementById("testImage");
      var askedImage = document.getElementById("askedImage");
      var ongoingTest = document.getElementById("ongoingTest");
      var operationImage = document.getElementById("operationImage");
      var sumAnswerInput = document.getElementById("sumAnswer");
      var isStarted = false;
      var isCalculationTestStarted = false;
      var calculationTestTotalValue = 0;
      var isAdjustTimeModeOn = false;
      var preRestInterval = 10000; // 10sec rest;
      var preRestIntervalOfRecord;
      var graphData = [];
      var durationsData = [];
      var edaData = accData = hrData = temperatureData = [];
      var edaDataLength = accDataLength = hrDataLength = temperatureDataLength = 0;
      var currentEdaChart;
      var analyzeTable = [];


      function onSdmtImageCountChanged() {
        numberOfImages = document.getElementById("imageCount").value;
        generateImageSequence().then(value => {
          imageSequence = value;
          console.log(imageSequence);
        });
      }

      // To be changed with onselection
      function answer(selection) {
        const sdmtImagePath = imageSequence[sdmtImageIndex];
        const imageCode = +(sdmtImagePath.substr(sdmtImagePath.indexOf('.png') - 1, 1));
        const correctness = !isCalculationTestStarted ? +selection === imageCode
                : +selection === (imageCode + calculationTestTotalValue);

        if(isCalculationTestStarted) {
          calculationTestTotalValue = correctness ? +selection : 0;
        }

        imagesShownTimeList.push({ imageFile: askedImage.src.substr(askedImage.src.indexOf("resource")), date: lastImageShownTime, dateAnswered: Date.now(), correct: correctness });

        if (++sdmtImageIndex < imageSequence.length) {
          setImage();
        } else if(!isCalculationTestStarted) {
          document.getElementById("sumAnswerBar").style.display = "flex";
          document.getElementById("selectionBar").style.display = "none";

          sumAnswerInput.focus();
          sumAnswerInput.value = '';
          isCalculationTestStarted = true;
          sdmtImageIndex = 0;
          calculationTestTotalValue = correctness ? +selection : 0;

          setImage();
        } else {
          stopTest(false);
        }
      }

      function setImage() {
        operationImage.style.display = (isCalculationTestStarted && calculationTestTotalValue > 0) ? "inline" : "none";

        askedImage.src = imageSequence[sdmtImageIndex];
        lastImageShownTime = Date.now();
      }

      async function generateImageSequence() {
        var generatedImageSequence = [];

        var allImagesCount = allSdmtImages.length;

        var lastImageIndexes = [];

        for (var i = 0; i < numberOfImages; i++) {
          var randomImageIndex;

          while(true) {
           randomImageIndex = Math.floor(Math.random() * allImagesCount);
            if(lastImageIndexes.indexOf(randomImageIndex) < 0) {
              lastImageIndexes.push(randomImageIndex);
              lastImageIndexes = lastImageIndexes.splice(-3);
              break;
            }
          }
          generatedImageSequence.push(allSdmtImages[randomImageIndex]);
        }

        return generatedImageSequence;
      }

      function getImages() {
        return $.getJSON('/sdmt-images');
      }

      async function loadImages() {
        allSdmtImages = await getImages();

        var allImages = [];
        for (var i = 0; i < allSdmtImages.length; i++) {
          allImages[i] = new Image();
          allImages[i].src = allSdmtImages[i];
        }
      }

      function initLocalStorage() {
        if (typeof (Storage) !== "undefined") {
          // Clear local storage
          localStorage.setItem("imagesShownTime", null);
          localStorage.setItem("sdmtImagesShownTime", null);

        } else {
          image.src = "../resources/images/Sorry.jpg";
          stopTest(true);
        }
      }

      function startRestTimer() {
        if (restTimer == null) {
          image.src = "../resources/images/rest.jpg";

          preRestInterval = localStorage.getItem("preRestInterval") || preRestInterval;

          restTimer = setInterval(finishRest, preRestInterval);

          testStartDate = Date.now();

          return restTimer;
        }
      }

      function finishRest() {
        if (restTimer != null) {
          clearInterval(restTimer);
          restTimer = null;

          var warning = document.getElementById("warningAudio");
          warning.play();

          startTest();
        }
      }

      function startTest() {
        isStarted = true;
        isCalculationTestStarted = false;
        ongoingTest.style.display = "flex";
        image.style.display = "none";
        initLocalStorage();
        imagesShownTimeList = [];
        document.getElementById("btnStart").disabled = true;
        document.getElementById("btnStop").disabled = false;

        document.getElementById("selectionBar").style.display = "block";
        document.getElementById("sumAnswerBar").style.display = "none";

        // Show first image
        sdmtImageIndex = 0;
        setImage();
      }

      function stopTest(isStoppedManually) {
        isStarted = false;
        isCalculationTestStarted = false;

        restTimer && clearInterval(restTimer);
        restTimer = null;

        ongoingTest.style.display = "none";
        image.style.display = "block";

        console.log("Test finished!");
        document.getElementById("btnStart").disabled = false;
        document.getElementById("btnStop").disabled = true;

        document.getElementById("selectionBar").style.display = "none";
        document.getElementById("sumAnswerBar").style.display = "none";

        if (isStoppedManually) {
          image.src = "../resources/images/sdmtTest.png";
          initLocalStorage();
        } else {
          image.src = "../resources/images/TestFinished.png";
          // Update local storage
          var strImagesShownTime = JSON.stringify(imagesShownTimeList);
          localStorage.setItem("sdmtImagesShownTime", strImagesShownTime);

          var parsableList = '{"times":' + strImagesShownTime + '}';
          //console.log(parsableList);
          imagesShownTimeList = JSON.parse(parsableList);

          var age = localStorage.getItem("userAge");
          var gender = localStorage.getItem("userGender");

          const metadataFileContent = {
            age,
            gender,
            imagesShownTimeList
          };

          if(lastDropboxFileId) {
            fetch(`/records/sdmt/${lastDropboxFileId}/metadata`, {
              method: 'POST',
              body: JSON.stringify(metadataFileContent),
              headers: {
                'Content-Type': 'application/json'
              }
            }).then( res => {
              if(res.ok) {
                console.log('Uploaded metadata file successfully!');
              } else {
                console.error('SDMT metadata file could not be saved! Dropbox id:' + lastDropboxFileId);
              }
            });
          }

        }
        sdmtImageIndex = 0;
      }

      function init() {
        initLocalStorage();
        checkForFileApiSupport();

        document.getElementById("imageCount").value = numberOfImages;

        loadImages().then(() => {
          generateImageSequence().then(value => {
            imageSequence = value;
          });
        });
      }

      function checkForFileApiSupport() {
        if (window.File && window.FileReader && window.FileList && window.Blob) {
          // All the File APIs are supported.
        }
        else {
          document.getElementById('alert').innerHTML = "The File APIs are not fully supported in this browser.";
        }
      }

      function prepareDurationsData() {
        analyzeTable = [];

        durationsData = [];

        const incrementHrIndexOnEdaCount = edaFrequency / hrFrequency;
        const incrementTemperatureIndexOnEdaCount = edaFrequency / temperatureFrequency;

        console.log("HR DATA: ", hrData);
        console.log("Temperature DATA: ", temperatureData);

        //console.log("imagesShownTimeList:", imagesShownTimeList);
        var i = edaInitIndex, j = 0, h = hrInitIndex, t = temperatureInitIndex;
        while (i < edaDataLength && j < imagesShownTimeList.times.length) {
          var diff = imagesShownTimeList.times[j].dateAnswered - imagesShownTimeList.times[j].dateImageShown;

          var hrDataInInterval = [], temperatureDataInInterval = [], edaDataInInterval = [];
          var count = 0;
          while (i * edaPeriodInMs + edaInitTimeInMs + adjustmentInMs < imagesShownTimeList.times[j].dateAnswered) {
            durationsData.push({ x: i, y: diff });

            if (count === 0 || count === incrementHrIndexOnEdaCount) {
              // Fix for init time difference between HR data and EDA data
              if (h < 0) {
                h = 0;
              }
              hrDataInInterval.push(hrData[h + 2])
            }

            if (count === 0 || count === incrementTemperatureIndexOnEdaCount) {
              temperatureDataInInterval.push(temperatureData[t + 2])
            }

            edaDataInInterval.push(edaData[i + 2])

            count++;
            i++;

            if (count === incrementHrIndexOnEdaCount) {
              h++;
            }

            if (count === incrementTemperatureIndexOnEdaCount) {
              t++;
            }
          }

          console.log("EDA Data In Interval: ", JSON.stringify(edaDataInInterval));

          console.log("HR Data In Interval: ", JSON.stringify(hrDataInInterval));

          console.log("Temperature Data In Interval: ", JSON.stringify(temperatureDataInInterval));

          analyzeTable.push({
            imageCode: imageCodes[j],
            delay: diff,
            correct: imagesShownTimeList.times[j].correct,
            avgHR: hrDataInInterval.reduce((acc, rate) => acc + +rate, 0) / hrDataInInterval.length,
            avgTemperature: temperatureDataInInterval.reduce((acc, temp) => acc + +temp, 0) / temperatureDataInInterval.length,
            rmsEDA: rootMeanSquare(edaDataInInterval),
            stdHR: standardDeviation(hrDataInInterval.map(h => +h))
          })

          j++;
        }


        console.log(JSON.stringify(analyzeTable, null, 2));

        drawEdaGraphics(edaData, edaInitTime, edaFrequency, "edaChartContainer");
      }

      function handleRecordFileSelection(evt) {
        var files = evt.target.files;

        var output = [];
        for (var i = 0, f; f = files[i]; i++) {
          output.push('<li><strong>', f.name, '</strong> (', f.type || 'n/a', ') - ',
            f.size, ' bytes, last modified: ',
            f.lastModifiedDate, '</li>');

          var r = new FileReader();
          r.onload = (function (f) {
            return function (e) {
              var contents = e.target.result;
              var splitted = contents.split('\n');

              userAge = parseInt(splitted[0]);
              userGender = splitted[1];

              console.log("Age: " + userAge);
              console.log("Gender: " + userGender);

              var imagesShownTimeInfo = splitted[2];
              // Remove quotes
              imagesShownTimeInfo = imagesShownTimeInfo.slice(1);
              imagesShownTimeInfo = imagesShownTimeInfo.slice(0, imagesShownTimeInfo.length - 1);

              // Remove backslashes
              //console.log("Before Replace :\n" + imagesShownTimeInfo);
              imagesShownTimeInfo = imagesShownTimeInfo.split('\\').join('');
              //console.log("After Replace :\n" + imagesShownTimeInfo);

              var parsableList = '{"times":' + imagesShownTimeInfo + '}';
              //console.log(parsableList);
              imagesShownTimeList = JSON.parse(parsableList);
              console.log(imagesShownTimeList);
              //console.log("First Answered: " + imagesShownTimeList.times[0].dateAnswered);
            };
          })(f);

          r.readAsText(f);

        }
        document.getElementById('selectedFile').innerHTML = '<ul>' + output.join('') + '</ul>';
      }

      function handleTemperatureFileSelection(evt) {
        var files = evt.target.files;

        var output = [];
        for (var i = 0, f; f = files[i]; i++) {
          output.push('<li><strong>', f.name, '</strong> (', f.type || 'n/a', ') - ',
            f.size, ' bytes, last modified: ',
            f.lastModifiedDate, '</li>');

          var r = new FileReader();
          r.onload = (function (f) {
            return function (e) {
              var contents = e.target.result;
              temperatureData = contents.split(/\r\n|\n/);

              temperatureDataLength = temperatureData.length - 2;

              temperatureInitTime = parseFloat(temperatureData[0].split(',')[0]);
              temperatureFrequency = parseFloat(temperatureData[1].split(',')[0]);

              drawTemperatureGraphics(temperatureData, temperatureInitTime, temperatureFrequency, "temperatureChartContainer");
            };
          })(f);

          r.readAsText(f);

        }
        document.getElementById('selectedFile').innerHTML = '<ul>' + output.join('') + '</ul>';
      }

      function handleHrFileSelection(evt) {
        var files = evt.target.files;

        var output = [];
        for (var i = 0, f; f = files[i]; i++) {
          output.push('<li><strong>', f.name, '</strong> (', f.type || 'n/a', ') - ',
            f.size, ' bytes, last modified: ',
            f.lastModifiedDate, '</li>');

          var r = new FileReader();
          r.onload = (function (f) {
            return function (e) {
              var contents = e.target.result;
              hrData = contents.split(/\r\n|\n/);

              hrDataLength = hrData.length - 2;

              hrInitTime = parseFloat(hrData[0].split(',')[0]);
              hrFrequency = parseFloat(hrData[1].split(',')[0]);

              drawHrGraphics(hrData, hrInitTime, hrFrequency, "hrChartContainer");
            };
          })(f);

          r.readAsText(f);

        }
        document.getElementById('selectedFile').innerHTML = '<ul>' + output.join('') + '</ul>';
      }

      function handleEdaFileSelection(evt) {
        var files = evt.target.files;

        var output = [];
        for (var i = 0, f; f = files[i]; i++) {
          output.push('<li><strong>', f.name, '</strong> (', f.type || 'n/a', ') - ',
            f.size, ' bytes, last modified: ',
            f.lastModifiedDate, '</li>');

          var r = new FileReader();
          r.onload = (function (f) {
            return function (e) {
              var contents = e.target.result;
              edaData = contents.split(/\r\n|\n/);

              edaDataLength = edaData.length - 2;

              edaInitTime = parseFloat(edaData[0]);
              edaInitTimeInMs = edaInitTime * 1000;
              edaFrequency = parseFloat(edaData[1]);
              edaPeriodInMs = 1000 / edaFrequency;
              drawEdaGraphics(edaData, edaInitTime, edaFrequency, "edaChartContainer");
            };
          })(f);

          r.readAsText(f);

        }
        document.getElementById('selectedFile').innerHTML = '<ul>' + output.join('') + '</ul>';
      }

      function handleAccFileSelection(evt) {
        var files = evt.target.files;

        var output = [];
        for (var i = 0, f; f = files[i]; i++) {
          output.push('<li><strong>', f.name, '</strong> (', f.type || 'n/a', ') - ',
            f.size, ' bytes, last modified: ',
            f.lastModifiedDate, '</li>');

          var r = new FileReader();
          r.onload = (function (f) {
            return function (e) {
              var contents = e.target.result;

              accData = contents.split(/\r\n|\n/);

              accDataLength = accData.length - 2;

              accInitTime = parseFloat(accData[0].split(',')[0]);
              accFrequency = parseFloat(accData[1].split(',')[0]);

              drawAccGraphics(accData, accInitTime, accFrequency, "accChartContainer");
            };
          })(f);

          r.readAsText(f);

        }
        document.getElementById('selectedFile').innerHTML = '<ul>' + output.join('') + '</ul>';

        document.getElementById('adjustTimeMode').style.display = "block";
      }

      function drawEdaGraphics(splitted, initTime, frequency, chartSelection) {
        graphData = [];

        var contentsAsDataPoint = [];

        // Increment in ms
        increment = (1 / frequency);

        for (var i = 2, time = initTime; i < splitted.length; i++ , time += increment) {
          //contentsAsDataPoint.push({ x: time,  y: parseFloat(splitted[i]) } );
          contentsAsDataPoint.push({ x: i - 2, y: parseFloat(splitted[i]) });
        }

        var edaGraphData = {
          click: onClick,
          type: "line",
          dataPoints: contentsAsDataPoint
        }

        graphData.push(edaGraphData);

        if (durationsData.length) {
          graphData.push(
            {
              showInLegend: true,
              name: "Durations",
              type: "scatter",
              axisYType: "secondary",
              dataPoints: durationsData
            }
          );
        }

        // Chart
        var chart = new CanvasJS.Chart(chartSelection, {
          zoomEnabled: true,
          panEnabled: true,
          legend: {
            horizontalAlign: "right",
            verticalAlign: "center"
          },
          axisY: {
            includeZero: false
          },
          axisY2: {
            includeZero: false
          },
          title: {
            text: "EDA"
          },
          data: graphData,
          legend: {
            cursor: "pointer",
            itemclick: function (e) {
              if (typeof (e.dataSeries.visible) === "undefined" || e.dataSeries.visible) {
                e.dataSeries.visible = false;
              } else {
                e.dataSeries.visible = true;
              }

              e.chart.render();
            }
          }
        });

        currentEdaChart = chart;
        chart.render();
      }

      function drawEcgGraphics(splitted, initTime, frequency, chartSelection) {
        var contentsAsDataPoint = [];
        // Increment in ms
        increment = (1 / frequency);

        for (var i = 2, time = initTime; i < splitted.length; i++ , time += increment) {
          //contentsAsDataPoint.push({ x: time,  y: parseFloat(splitted[i]) } );
          contentsAsDataPoint.push({ y: parseFloat(splitted[i]) });
        }

        graphData = [
          {
            showInLegend: false,
            click: onClick,
            type: "line",
            dataPoints: contentsAsDataPoint
          }
        ];

        // Chart
        var chart = new CanvasJS.Chart(chartSelection, {
          zoomEnabled: true,
          panEnabled: true,
          legend: {
            horizontalAlign: "right",
            verticalAlign: "center"
          },
          axisY: {
            includeZero: false
          },
          title: {
            text: "ECG"
          },
          data: graphData
        });
        chart.render();
      }

      function myTrim(x) {
        return x.replace(/^\s+|\s+$/gm, '');
      }

      function drawAccGraphics(splitted, initTime, frequency, chartSelection) {
        var xContentsAsDataPoint = [];
        var yContentsAsDataPoint = [];
        var zContentsAsDataPoint = [];

        // Increment in ms
        accIncrement = (1 / frequency);

        for (var i = 2, time = initTime; i < splitted.length; i++ , time += increment) {
          //contentsAsDataPoint.push({ x: time,  y: parseFloat(splitted[i]) } );

          // Check empty line
          if (!splitted[i]) {
            break;
          }

          var xyzValues = splitted[i].split(',');

          xContentsAsDataPoint.push({ y: parseFloat(myTrim(xyzValues[0])) });
          yContentsAsDataPoint.push({ y: parseFloat(myTrim(xyzValues[1])) });
          zContentsAsDataPoint.push({ y: parseFloat(myTrim(xyzValues[2])) });
        }

        // Chart
        var chart = new CanvasJS.Chart(chartSelection, {
          zoomEnabled: true,
          panEnabled: true,
          legend: {
            horizontalAlign: "right",
            verticalAlign: "center"
          },
          axisY: {
            includeZero: false
          },
          title: {
            text: "ACC"
          },
          data: [
            {
              click: onAccClick,
              type: "line",
              dataPoints: xContentsAsDataPoint
            },
            {
              click: onAccClick,
              type: "line",
              dataPoints: yContentsAsDataPoint
            },
            {
              click: onAccClick,
              type: "line",
              dataPoints: zContentsAsDataPoint
            }
          ]
        });
        chart.render();
      }


      function drawHrGraphics(splitted, initTime, frequency, chartSelection) {
        var contentsAsDataPoint = [];

        // Increment in ms
        hrIncrement = (1 / hrFrequency);

        for (var i = 2, time = initTime; i < splitted.length; i++ , time += hrIncrement) {
          //contentsAsDataPoint.push({ x: time,  y: parseFloat(splitted[i]) } );
          contentsAsDataPoint.push({ x: i - 2, y: parseFloat(splitted[i]) });
        }

        // Chart
        var chart = new CanvasJS.Chart(chartSelection, {
          zoomEnabled: true,
          panEnabled: true,
          legend: {
            horizontalAlign: "right",
            verticalAlign: "center"
          },
          axisY: {
            includeZero: false
          },
          title: {
            text: "HR"
          },
          data: [
            {
              type: "line",
              dataPoints: contentsAsDataPoint
            }
          ]
        });
        chart.render();
      }


      function drawTemperatureGraphics(splitted, initTime, frequency, chartSelection) {
        var contentsAsDataPoint = [];

        // Increment in ms
        temperatureIncrement = (1 / temperatureFrequency);

        for (var i = 2, time = initTime; i < splitted.length; i++ , time += temperatureIncrement) {
          //contentsAsDataPoint.push({ x: time,  y: parseFloat(splitted[i]) } );
          contentsAsDataPoint.push({ x: i - 2, y: parseFloat(splitted[i]) });
        }

        // Chart
        var chart = new CanvasJS.Chart(chartSelection, {
          zoomEnabled: true,
          panEnabled: true,
          legend: {
            horizontalAlign: "right",
            verticalAlign: "center"
          },
          axisY: {
            includeZero: false
          },
          title: {
            text: "Temperature"
          },
          data: [
            {
              type: "line",
              dataPoints: contentsAsDataPoint
            }
          ]
        });
        chart.render();
      }

      function onClick(e) {
        var timeOfPoint = edaInitTime + (e.dataPoint.x * increment);
        setImageAtTime(timeOfPoint);
      }

      function onAccClick(e) {
        edaInitIndex = Math.ceil(e.dataPoint.x / (accFrequency / edaFrequency));
        hrInitIndex = Math.ceil(e.dataPoint.x / (accFrequency / hrFrequency) - ((hrInitTime - edaInitTime) / hrFrequency));
        temperatureInitIndex = Math.ceil(e.dataPoint.x / (accFrequency / temperatureFrequency));
        var timeOfPoint = accInitTime + (e.dataPoint.x * accIncrement);

        isAdjustTimeModeOn = document.getElementById("adjustTimeModeOn").checked;
        if (isAdjustTimeModeOn) {
          adjustmentInMs = parseInt(imagesShownTimeList.times[0].dateImageShown) - (timeOfPoint * 1000);
          console.log("Adjustment: " + adjustmentInMs);

          prepareDurationsData();

        } else {
          setImageAtTime(timeOfPoint);
        }
      }

      function setImageAtTime(timeOfPoint) {
        let timeOfPointInMs = timeOfPoint * 1000;
        timeOfPointInMs += adjustmentInMs;

        console.log("setImageAtTime:" + timeOfPointInMs);

        if (imagesShownTimeList != [] && parseInt(imagesShownTimeList.times[0].dateImageShown) <= timeOfPointInMs) {
          for (var i = 0; i < imagesShownTimeList.times.length; i++) {

            if (parseInt(imagesShownTimeList.times[i].dateImageShown) >= timeOfPointInMs) {
              askedImage.src = JSON.stringify(imagesShownTimeList.times[i].imageFile).split('"').join('');
              break;
            }
          }
        } else {
          askedImage.src = "../resources/images/imageNotFound.png";
        }
      }

    </script>
  </div>

</body>

</html>
