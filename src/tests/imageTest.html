<!DOCTYPE html>
<html>

<head>
  <script src="https://canvasjs.com/assets/script/canvasjs.min.js"></script>
  <script src="https://code.jquery.com/jquery-2.2.3.min.js"></script>
  <meta charset='utf-8'>
  <title>Resim Testi</title>
</head>

<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.bundle.min.js"></script>
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
<script src="/socket.io/socket.io.js"></script>
<script>
  var lastDropboxFileId;

  var socket = io('/');
  socket.on('connect', function () {
    console.log("Websocket Connected, id: ", socket.id);

    document.getElementById("wsId").innerHTML = socket.id.substr(0, 4).toLowerCase();

  });
  socket.on('disconnect', function () { });

  socket.on('start-image-test', function (fileId) {
    console.log("Starting test! File Id:", fileId);
    lastDropboxFileId = fileId;

    document.getElementById("dropboxFile").value = fileId;

    startTimer();
  });

</script>

<body>

  <div>
    <span id="lblInterval">Aralık: </span><input id="interval" type="number" class=".form-control-sm">ms</input>
    <span id="lblCount">Adet: </span><input id="imageCount" type="number" class=".form-control-sm" onchange="onImageCountChanged()"/>
    <button id="btnStart" class="btn btn-primary btn-sm" onclick="startTimer()">Teste başla</button>
    <button id="btnStop" class="btn btn-danger btn-sm" onclick="stopTimer(1)" disabled=true>Durdur</button>
    <output id="selectedFile"></output>
    <span id="lblClientId">Kullanıcı ID: </span><output id="wsId"></output>
  </div>
  <div>
    <div id="alert"></div>
  </div>
  <div>
    <audio id="warningAudio" controls hidden>
      <source src="../resources/sounds/warning.mp3" type="audio/mpeg">
      Your browser does not support the audio tag.
    </audio>
    <audio id="noiseAudio" controls hidden>
      <source src="../resources/sounds/chirp.mp3" type="audio/mpeg">
      Your browser does not support the audio tag.
    </audio>
  </div>
  <div>
    <img id="testImage" src="../resources/images/ResimTesti.png" style="width:800px;height:600px" />
  </div>

  <div>
    <button type="button" onclick="listFolders()" class="btn btn-info btn-sm" data-toggle="modal" data-target="#modalSelectRecord">Dropbox</button>
    <input id="dropboxFile" type="text" placeholder="Dropbox id"/>
    <button id="btnLoadRecords" onclick="loadFromDropbox()">Yükle</button>
  </div>


  <div id="edaChartContainer" style="height: 300px; width: 100%;"></div>
  <div id="ecgChartContainer" style="height: 300px; width: 100%;"></div>
  <div id="accChartContainer" style="height: 300px; width: 100%;"></div>
  <div id="adjustTimeMode" style="display: none">
    <span id="adjust_Time_Mode">Zaman Ayarlama Modu :</span><input id="adjustTimeModeOn" type="radio"
      name="adjustTimeMode" /><span id="adjust_Time_Mode_On">Açık</span>
    <input id="adjustTimeModeOff" type="radio" name="adjustTimeMode" checked /><span
      id="adjust_Time_Mode_Off">Kapalı</span>
  </div>

  <!--Perform translation -->
  <script type="text/javascript" src="../resources/js/translate.js"></script>

  <!-- Modal -->
  <div id="modalSelectRecord" class="modal fade" role="dialog">
    <div class="modal-dialog">
      <!-- Modal content-->
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title">Select Record</h4>
          <button type="button" class="close" data-dismiss="modal">&times;</button>
        </div>
        <div id="recordListInModal" class="modal-body"/>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <script type="text/javascript">
    window.addEventListener('load', init, false);
    window.addEventListener('keydown', this.keyPress, false);

    var adjustmentInMs = 0;
    var deltaInMs = 250;

    function keyPress(e) {
      var code = e.keyCode;

      switch (code) {
        // + key
        case 187: adjustmentInMs += deltaInMs; console.log("Adjustment: " + adjustmentInMs); break;
        // - key
        case 189: adjustmentInMs -= deltaInMs; console.log("Adjustment: " + adjustmentInMs); break;
      }
    }
    var imageSequence = [];
    var imageIndex = 0;
    var numberOfImages = 50;
    var imageTimer = null;
    var restTimer = null;
    var noiseTimer = null;
    var imagesShownTimeList = [];
    var edaInitTime, accInitTime;
    var edaFrequency, accFrequency;
    var increment, accIncrement;
    var testStartDate = 0;
    var interval = 1000;
    var intervalOfRecord;
    var noiseInterval = 3000;
    var isAdjustTimeModeOn = false;
    var categoryShift = 0;
    var usingSyncRecord = false;

    var image = document.getElementById("testImage");

    function loadImages() {
      var allImages = [];
      for (i = 0; i < imageSequence.length; i++) {
        allImages[i] = new Image();
        allImages[i].src = imageSequence[i];
      }
    }

    function getImages() {
      return $.getJSON('/images');
    }

    async function generateImageSequence() {
      var generatedImageSequence = [];

      const images = await getImages();

      var allImagesCount = images.length;

      for (var i = 0; i < numberOfImages; i++) {
        var randomImageIndex = Math.floor(Math.random() * allImagesCount);
        generatedImageSequence.push(images[randomImageIndex]);
      }

      return generatedImageSequence;
    }

    function onImageCountChanged() {
      numberOfImages = document.getElementById("imageCount").value;
      generateImageSequence().then(value => {
        imageSequence = value;
        loadImages();
      });
    }

    function initLocalStorage() {
      if (typeof (Storage) !== "undefined") {
        // Clear local storage
        localStorage.setItem("imagesShownTime", null);
      } else {
        image.src = "../resources/images/Sorry.jpg";
        stopTimer(true);
      }
    }

    function startRestTimer() {
      var restInterval = 5000; // 30sec rest
      if (restTimer == null) {

        image.src = "../resources/images/rest.jpg";

        restTimer = setInterval(haveRest, restInterval);

        return restTimer;
      }
    }

    function haveRest() {
      if (restTimer != null) {
        clearInterval(restTimer);
        restTimer = null;

        var warning = document.getElementById("warningAudio");
        warning.play();

        imageTimer = setInterval(imageChanger, interval);
        noiseInterval = interval * 3;
        noiseTimer = setInterval(makeNoise, noiseInterval);

        imageChanger();
      }
    }

    function makeNoise() {
      if (noiseTimer != null) {
        var noiseAudio = document.getElementById("noiseAudio");
        noiseAudio.play();
      }
    }

    function startTimer() {

      initLocalStorage();
      if (imageTimer == null) {
        interval = document.getElementById("interval").value;

        testStartDate = parseInt(Date.now());

        document.getElementById("btnStart").disabled = true;
        document.getElementById("btnStop").disabled = false;

        imagesShownTimeList = [];

        return startRestTimer();
      }
    }

    function httpGetAsync(theUrl, callback) {
      var xmlHttp = new XMLHttpRequest();
      xmlHttp.onreadystatechange = function () {
        if (xmlHttp.readyState == 4 && xmlHttp.status == 200)
          callback(xmlHttp.responseText);
      }
      xmlHttp.open("GET", theUrl, true); // true for asynchronous 
      xmlHttp.send(null);
    }

    function loadFromDropbox() {
      const recordId = document.getElementById("dropboxFile").value;
      if (recordId) {
        usingSyncRecord = true;

        // Load metadata file
        httpGetAsync(`/records/${recordId}?file=metadata`, function (response) {
          const jsonContent = JSON.parse(response);

          console.log("Age: " + jsonContent.age);
          console.log("Gender: " + jsonContent.gender);

          intervalOfRecord = jsonContent.interval;
          console.log("Interval: " + intervalOfRecord);

          imagesShownTimeList = jsonContent.imagesShownTimeList;
          console.log("ImagesShownTimeList: " + imagesShownTimeList);

          //Load EDA file
          httpGetAsync(`/records/${recordId}`, function (response) {
            console.log('EDA file loaded.')
            var splitted = response.split(/\r\n|\n/);

            edaInitTime = parseFloat(splitted[0]);
            edaFrequency = parseFloat(splitted[1]);

            drawEdaGraphics(splitted, edaInitTime, edaFrequency, "edaChartContainer");
          });

          // Load ECG file
          httpGetAsync(`/records/${recordId}?file=ecg`, function (response) {
            console.log('ECG file loaded.')
            var splitted = response.split(/\r\n|\n/);

            ecgInitTime = parseFloat(splitted[0]);
            ecgFrequency = parseFloat(splitted[1]);

            drawEcgGraphics(splitted, edaInitTime, edaFrequency, "ecgChartContainer");
          });
        });
      }
    }

    function setDropboxId(id) {
      document.getElementById("dropboxFile").value = id;
      $('#modalSelectRecord').modal('hide');
    }

    function listFolders() {
      httpGetAsync('/records', function (res) {
        const recordList = JSON.parse(res).map(record => `<li onclick="setDropboxId('${record}')">${record}</li>`).join('');

        document.getElementById("recordListInModal").innerHTML = `<ul>${recordList}</ul>`
      });
    }

    function stopTimer(isStoppedManually) {
      if (imageTimer != null || restTimer != null) {
        document.getElementById("btnStart").disabled = false;
        document.getElementById("btnStop").disabled = true;

        if (isStoppedManually) {
          image.src = "../resources/images/ResimTesti.png";
          initLocalStorage();
        } else {
          // Update local storage
          var strImagesShownTime = JSON.stringify(imagesShownTimeList);
          localStorage.setItem("imagesShownTime", strImagesShownTime);

          var parsableList = '{"times":' + strImagesShownTime + '}';
          //console.log(parsableList);
          imagesShownTimeList = JSON.parse(parsableList);

          var age = localStorage.getItem("userAge");
          var gender = localStorage.getItem("userGender");

          const metadataFileContent = {
            age,
            gender,
            interval,
            imagesShownTimeList
          };

          if(lastDropboxFileId) {
            fetch(`/records/${lastDropboxFileId}/metadata`, {
              method: 'POST',
              body: JSON.stringify(metadataFileContent),
              headers: {
                'Content-Type': 'application/json'
              }
            }).then( res => {
              if(res.ok) {
                console.log('Uploaded metadata file successfully!');
              } else {
                console.error('Metadata could not be saved! Dropbox id:' + lastDropboxFileId);
              }
            });
          }
        }

        clearInterval(restTimer);
        restTimer = null;

        clearInterval(imageTimer);
        imageTimer = null;
        imageIndex = 0;

        clearInterval(noiseTimer);
        noiseTimer = null;
      }
    }

    function imageChanger() {
      if (imageIndex >= numberOfImages) {
        stopTimer(false);
        image.src = "../resources/images/TestFinished.png";
        return;
      }

      image.src = imageSequence[imageIndex];

      imagesShownTimeList.push({ imageFile: image.src.substr(image.src.indexOf("resource")), date: Date.now() });

      imageIndex++;
    }

    function init() {
      initLocalStorage();
      checkForFileApiSupport();

      document.getElementById("imageCount").value = numberOfImages;
      generateImageSequence().then(value => {
        imageSequence = value;
        loadImages();
      });

      document.getElementById("interval").value = interval;
    }

    function checkForFileApiSupport() {
      if (window.File && window.FileReader && window.FileList && window.Blob) {
        // All the File APIs are supported.
      }
      else {
        document.getElementById('alert').innerHTML = "The File APIs are not fully supported in this browser.";
      }
    }

    function handleRecordFileSelection(evt) {
      var files = evt.target.files;

      for (var i = 0, f; f = files[i]; i++) {
        var r = new FileReader();
        r.onload = (function (f) {
          return function (e) {
            var contents = e.target.result;

            const jsonContent = JSON.parse(contents);

            console.log("Age: " + jsonContent.age);
            console.log("Gender: " + jsonContent.gender);
            console.log("Interval: " + jsonContent.interval);

            imagesShownTimeList = jsonContent.imagesShownTimeList;
            console.log("ImagesShownTimeList: " + imagesShownTimeList);
          };
        })(f);

        r.readAsText(f);

      }
    }

    function handleEdaFileSelection(evt) {
      usingSyncRecord = false;

      var files = evt.target.files;
      var output = [];
      for (var i = 0, f; f = files[i]; i++) {
        output.push('<li><strong>', f.name, '</strong> (', f.type || 'n/a', ') - ',
          f.size, ' bytes, last modified: ',
          f.lastModifiedDate, '</li>');

        var r = new FileReader();
        r.onload = (function (f) {
          return function (e) {
            var contents = e.target.result;
            var splitted = contents.split(/\r\n|\n/);

            edaInitTime = parseFloat(splitted[0]);
            edaFrequency = parseFloat(splitted[1]);

            drawEdaGraphics(splitted, edaInitTime, edaFrequency, "edaChartContainer");
          };
        })(f);

        r.readAsText(f);
      }
      document.getElementById('selectedFile').innerHTML = '<ul>' + output.join('') + '</ul>';
    }

    function handleAccFileSelection(evt) {
      var files = evt.target.files;

      var output = [];
      for (var i = 0, f; f = files[i]; i++) {
        output.push('<li><strong>', f.name, '</strong> (', f.type || 'n/a', ') - ',
          f.size, ' bytes, last modified: ',
          f.lastModifiedDate, '</li>');

        var r = new FileReader();
        r.onload = (function (f) {
          return function (e) {
            var contents = e.target.result;
            var splitted = contents.split(/\r\n|\n/);

            accInitTime = parseFloat(splitted[0].split(',')[0]);
            accFrequency = parseFloat(splitted[1].split(',')[0]);

            console.log(accFrequency);

            drawAccGraphics(splitted, accInitTime, accFrequency, "accChartContainer");
          };
        })(f);

        r.readAsText(f);

      }
      document.getElementById('selectedFile').innerHTML = '<ul>' + output.join('') + '</ul>';
      document.getElementById('adjustTimeMode').style.display = "block";
    }

    var photoTypeDataPoints = [];
    var graphData = [];
    var currentEdaChart;
    var pointsInInterval;

    function drawEdaGraphics(splitted, initTime, frequency, chartSelection) {
      var contentsAsDataPoint = [];
      // Increment in ms
      increment = (1 / frequency);
      var interval = intervalOfRecord;
      pointsInInterval = frequency * (interval / 1000);
      console.log('Freq: ' + frequency + ',  PointsForOneImage: ' + pointsInInterval);

      for (var i = 2, time = initTime; i < splitted.length; i++ , time += increment) {
        //contentsAsDataPoint.push({ x: time,  y: parseFloat(splitted[i]) } );
        contentsAsDataPoint.push({ y: parseFloat(splitted[i]) });
      }

      for (var i = 0; i < numberOfImages; i++) {
        var pathRegexp = /\/categories\/(.*?)\//g;
        var categoryGroup = [];
        var path = imageSequence[i];
        var match = pathRegexp.exec(path);

        while (i < numberOfImages) {
          var currentPathRegexp = /\/categories\/(.*?)\//g;
          var currentPath = imageSequence[i];
          var currentMatch = currentPathRegexp.exec(currentPath);
          if (currentMatch[1] == match[1]) {

            for (var j = 0; j < pointsInInterval; j++) {
              categoryGroup.push({ x: pointsInInterval * i + j + categoryShift, y: -0.01 });
            }

            i++;
          } else {
            i--;
            break;
          }
        }

        photoTypeDataPoints.push({ type: match[1], categoryGroup });
      }
      console.log(photoTypeDataPoints);

      graphData = [
        {
          showInLegend: false,
          click: onClick,
          type: "line",
          dataPoints: contentsAsDataPoint
        }
      ];

      for (var i = 0; i < photoTypeDataPoints.length; i++) {
        graphData.push(
          {
            showInLegend: true,
            name: photoTypeDataPoints[i].type,
            type: "line",
            dataPoints: photoTypeDataPoints[i].categoryGroup
          }
        );
      }


      // Chart
      var chart = new CanvasJS.Chart(chartSelection, {
        zoomEnabled: true,
        panEnabled: true,
        legend: {
          horizontalAlign: "right",
          verticalAlign: "center"
        },
        axisY: {
          includeZero: false
        },
        title: {
          text: "EDA"
        },

        data: graphData,

        legend: {
          cursor: "pointer",
          itemclick: function (e) {
            //console.log("legend click: " + e.dataPointIndex);
            //console.log(e);
            if (typeof (e.dataSeries.visible) === "undefined" || e.dataSeries.visible) {
              e.dataSeries.visible = false;
            } else {
              e.dataSeries.visible = true;
            }

            e.chart.render();
          }
        }
      });
      chart.render();

      currentEdaChart = chart;
    }

    function drawEcgGraphics(splitted, initTime, frequency, chartSelection) {
      var contentsAsDataPoint = [];
      // Increment in ms
      increment = (1 / frequency);

      pointsInInterval = frequency * (intervalOfRecord / 1000);
      console.log('Freq: ' + frequency + ',  PointsForOneImage: ' + pointsInInterval);

      for (var i = 2, time = initTime; i < splitted.length; i++ , time += increment) {
        //contentsAsDataPoint.push({ x: time,  y: parseFloat(splitted[i]) } );
        contentsAsDataPoint.push({ y: parseFloat(splitted[i]) });
      }

      graphData = [
        {
          showInLegend: false,
          click: onClick,
          type: "line",
          dataPoints: contentsAsDataPoint
        }
      ];

      // Chart
      var chart = new CanvasJS.Chart(chartSelection, {
        zoomEnabled: true,
        panEnabled: true,
        legend: {
          horizontalAlign: "right",
          verticalAlign: "center"
        },
        axisY: {
          includeZero: false
        },
        title: {
          text: "ECG"
        },
        data: graphData
      });
      chart.render();
    }

    function myTrim(x) {
      return x.replace(/^\s+|\s+$/gm, '');
    }

    function drawAccGraphics(splitted, initTime, frequency, chartSelection) {
      var xContentsAsDataPoint = [];
      var yContentsAsDataPoint = [];
      var zContentsAsDataPoint = [];

      // Increment in ms
      accIncrement = (1 / frequency);

      for (var i = 2, time = initTime; i < splitted.length; i++ , time += accIncrement) {
        //contentsAsDataPoint.push({ x: time,  y: parseFloat(splitted[i]) } );

        // Check empty line
        if (!splitted[i]) {
          break;
        }

        var xyzValues = splitted[i].split(',');

        xContentsAsDataPoint.push({ y: parseFloat(myTrim(xyzValues[0])) });
        yContentsAsDataPoint.push({ y: parseFloat(myTrim(xyzValues[1])) });
        zContentsAsDataPoint.push({ y: parseFloat(myTrim(xyzValues[2])) });
      }

      // Chart
      var chart = new CanvasJS.Chart(chartSelection, {
        zoomEnabled: true,
        panEnabled: true,
        legend: {
          horizontalAlign: "right",
          verticalAlign: "center"
        },
        axisY: {
          includeZero: false
        },
        title: {
          text: "ACC"
        },
        data: [
          {
            click: onAccClick,
            type: "line",
            dataPoints: xContentsAsDataPoint
          },
          {
            click: onAccClick,
            type: "line",
            dataPoints: yContentsAsDataPoint
          },
          {
            click: onAccClick,
            type: "line",
            dataPoints: zContentsAsDataPoint
          }
        ]
      });
      chart.render();
    }

    function onClick(e) {
      var timeOfPoint = edaInitTime + (e.dataPoint.x * increment);
      if (usingSyncRecord) {
        setImageAtIndex(e.dataPoint.x);
      } else {
        setImageAtTime(timeOfPoint);
      }
    }

    function onAccClick(e) {
      var timeOfPoint = accInitTime + (e.dataPoint.x * accIncrement);

      isAdjustTimeModeOn = document.getElementById("adjustTimeModeOn").checked;
      if (isAdjustTimeModeOn) {
        adjustmentInMs = parseInt(imagesShownTimeList.times[0].date) - (timeOfPoint * 1000);
        console.log("Adjustment: " + adjustmentInMs);

        categoryShift = (e.dataPoint.x / accFrequency) * edaFrequency;

        shiftCategoryIndexes();
      } else {
        setImageAtTime(timeOfPoint);
      }
    }

    function shiftCategoryIndexes() {
      //var interval = document.getElementById('interval').value;
      //var pointsInInterval = edaFrequency * (interval / 1000);

      for (var i = 1, count = 0; i < graphData.length; i++) {
        for (var j = 0; j < graphData[i].dataPoints.length; j++) {
          graphData[i].dataPoints[j].x = count + categoryShift;
          count++;
        }
      }
      currentEdaChart.render();
    }

    function setImageAtIndex(index) {
      console.log("setImageAtIndex:" + index, "pointsInInterval: " + pointsInInterval);

      var imageIndex = Math.floor(index / pointsInInterval);
      if (imageIndex >= imageSequence.length) {
        image.src = "../resources/images/imageNotFound.png";
      } else {
        image.src = JSON.stringify(imageSequence[imageIndex]).split('"').join('');
      }
    }

    function setImageAtTime(timeOfPoint) {
      let timeOfPointInMs = timeOfPoint * 1000;
      timeOfPointInMs += adjustmentInMs;

      console.log("setImageAtTime:" + timeOfPointInMs);
      console.log("First image is shown at: " + JSON.stringify(imagesShownTimeList.times[0].date));

      if (imagesShownTimeList != [] && parseInt(imagesShownTimeList.times[0].date) <= timeOfPointInMs) {
        for (var i = 1; i < imagesShownTimeList.times.length; i++) {
          //console.log(JSON.stringify(imagesShownTimeList.times[i].dateImageShown));

          if (parseInt(imagesShownTimeList.times[i].date) >= timeOfPointInMs) {
            image.src = JSON.stringify(imagesShownTimeList.times[i - 1].imageFile).split('"').join('');

            console.log(image.src);
            break;
          } else if (i == imagesShownTimeList.times.length - 1 && timeOfPointInMs > parseInt(imagesShownTimeList.times[i].date)) {
            // Last image
            image.src = JSON.stringify(imagesShownTimeList.times[i].imageFile).split('"').join('');
            console.log(image.src);
            break;

          }
        }
      } else {
        console.log("Image not found!");
        image.src = "../resources/images/imageNotFound.png";
      }
    }
  </script>
</body>

</html>
